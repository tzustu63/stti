<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>即時逐字稿測試</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .status.connected {
        background-color: #d4edda;
        color: #155724;
      }
      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      .status.recording {
        background-color: #fff3cd;
        color: #856404;
      }
      .transcript {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
        min-height: 100px;
      }
      .transcript.partial {
        border-left: 4px solid #ffc107;
      }
      .transcript.final {
        border-left: 4px solid #28a745;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      button.stop {
        background-color: #dc3545;
      }
      button.stop:hover {
        background-color: #c82333;
      }
      .log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>即時逐字稿測試</h1>

      <div id="status" class="status disconnected">未連線</div>

      <div>
        <button id="startBtn" onclick="startRecording()">開始錄音</button>
        <button id="stopBtn" onclick="stopRecording()" disabled class="stop">
          停止錄音
        </button>
      </div>

      <div class="transcript" id="transcript">
        <p>等待語音輸入...</p>
      </div>

      <div class="transcript" id="translation">
        <p>等待翻譯結果...</p>
      </div>

      <div class="log" id="log"></div>
    </div>

    <script>
      let ws = null;
      let isRecording = false;
      let audioContext = null;
      let processor = null;
      let source = null;
      let stream = null;

      function log(message) {
        const logDiv = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${timestamp}] ${message}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      function updateStatus(message, className) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = `status ${className}`;
      }

      function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.hostname;
        const port =
          host === "localhost" ? "3000" : window.location.port || "3000";
        const wsUrl = `${protocol}//${host}:${port}`;

        log(`嘗試連接到 WebSocket: ${wsUrl}`);
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          log("WebSocket 連線已建立");
          updateStatus("已連線", "connected");
        };

        ws.onclose = (event) => {
          log(`WebSocket 連線已關閉: ${event.code} ${event.reason}`);
          updateStatus("連線已關閉", "disconnected");
        };

        ws.onerror = (error) => {
          log(`WebSocket 錯誤: ${error}`);
          updateStatus("連線錯誤", "disconnected");
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            log(`收到訊息: ${JSON.stringify(data, null, 2)}`);

            switch (data.type) {
              case "transcript":
                // 只處理最終轉錄結果
                if (data.data.is_final) {
                  updateTranscript(data.data.utterance.text, true);
                } else {
                  log(`部分轉錄（忽略）: "${data.data.utterance.text}"`);
                }
                break;
              case "translation":
                updateTranslation(data.data.translated_utterance.text);
                break;
              case "recording_started":
                log("錄音已開始");
                break;
              case "recording_stopped":
                log("錄音已停止");
                break;
              case "error":
                log(`錯誤: ${data.message}`);
                break;
            }
          } catch (error) {
            log(`解析訊息失敗: ${error}`);
          }
        };
      }

      function updateTranscript(text, isFinal) {
        const transcriptDiv = document.getElementById("transcript");
        transcriptDiv.innerHTML = `<p>${text}</p>`;
        transcriptDiv.className = `transcript ${isFinal ? "final" : "partial"}`;
        log(`轉錄結果: "${text}" (${isFinal ? "最終" : "部分"})`);
      }

      function updateTranslation(text) {
        const translationDiv = document.getElementById("translation");
        translationDiv.innerHTML = `<p>${text}</p>`;
        log(`翻譯結果: "${text}"`);
      }

      async function startRecording() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          log("WebSocket 未連線");
          return;
        }

        try {
          // 發送配置訊息
          ws.send(
            JSON.stringify({
              type: "config",
              sourceLang: "zh",
              targetLang: "en",
            })
          );

          // 獲取麥克風權限 - 優化音訊品質設定
          stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              sampleRate: 16000,
              channelCount: 1,
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true,
              // 新增優化參數以提升音訊品質
              latency: 0.01, // 最小延遲
              googEchoCancellation: true,
              googNoiseSuppression: true,
              googAutoGainControl: true,
              googHighpassFilter: true,
              googTypingNoiseDetection: true,
              googAudioMirroring: false,
              googDAEchoCancellation: true,
              googNoiseReduction: true,
            },
          });

          // 創建 AudioContext
          audioContext = new (window.AudioContext || window.webkitAudioContext)(
            {
              sampleRate: 16000,
            }
          );

          // 創建音訊源
          source = audioContext.createMediaStreamSource(stream);

          // 創建 ScriptProcessorNode
          processor = audioContext.createScriptProcessor(4096, 1, 1);

          processor.onaudioprocess = (event) => {
            if (!isRecording) return;

            const inputBuffer = event.inputBuffer;
            const inputData = inputBuffer.getChannelData(0);

            // 轉換為 PCM 16-bit
            const pcmData = new Int16Array(inputData.length);
            for (let i = 0; i < inputData.length; i++) {
              pcmData[i] = Math.max(
                -32768,
                Math.min(32767, inputData[i] * 32768)
              );
            }

            // 轉換為 base64
            const base64Pcm = btoa(
              String.fromCharCode(...new Uint8Array(pcmData.buffer))
            );

            // 發送到 WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(
                JSON.stringify({
                  type: "audio_chunk",
                  data: { chunk: base64Pcm },
                })
              );
            }
          };

          // 連接音訊節點
          source.connect(processor);
          processor.connect(audioContext.destination);

          isRecording = true;
          updateStatus("錄音中...", "recording");
          document.getElementById("startBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;
          log("開始錄音");
        } catch (error) {
          log(`無法開始錄音: ${error.message}`);
        }
      }

      function stopRecording() {
        if (!isRecording) return;

        isRecording = false;

        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }

        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }

        if (processor) {
          processor.disconnect();
          processor = null;
        }

        if (source) {
          source.disconnect();
          source = null;
        }

        // 發送停止錄音訊息
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "stop_recording",
            })
          );
        }

        updateStatus("已連線", "connected");
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        log("停止錄音");
      }

      // 頁面載入時連線
      window.onload = () => {
        connectWebSocket();
      };
    </script>
  </body>
</html>
